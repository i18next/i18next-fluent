!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.i18nextFluent=e()}(this,function(){"use strict";function t(t,e,s){function i(t){return t&&t.indexOf("###")>-1?t.replace(/###/g,"."):t}function n(){return!t||"string"==typeof t}const r="string"!=typeof e?[].concat(e):e.split(".");for(;r.length>1;){if(n())return{};const e=i(r.shift());!t[e]&&s&&(t[e]=new s),t=t[e]}return n()?{}:{obj:t,k:i(r.shift())}}function e(e,s){const{obj:i,k:n}=t(e,s);if(i)return i[n]}let s=[],i=s.forEach,n=s.slice;const r=100,o=/-?[a-zA-Z][a-zA-Z0-9_-]*/y,h=/[a-zA-Z][a-zA-Z0-9_-]*/y,a=/^[A-Z][A-Z_?-]*$/,c=/^[a-fA-F0-9]{4}$/,u=/[ \t\n\r]+$/;class l{getResource(t){this._source=t,this._index=0,this._length=t.length,this.entries={};const e=[];for(this.skipWS();this._index<this._length;){try{this.getEntry()}catch(t){if(!(t instanceof SyntaxError))throw t;e.push(t),this.skipToNextEntryStart()}this.skipWS()}return[this.entries,e]}getEntry(){if(0!==this._index&&"\n"!==this._source[this._index-1])throw this.error("Expected an entry to start\n        at the beginning of the file or on a new line.");"#"===this._source[this._index]&&[" ","#","\n"].includes(this._source[this._index+1])?this.skipComment():this.getMessage()}getMessage(){const t=this.getEntryIdentifier();if(this.skipInlineWS(),"="!==this._source[this._index])throw this.error('Expected "=" after the identifier');this._index++,this.skipInlineWS();const e=this.getPattern();if(t.startsWith("-")&&null===e)throw this.error("Expected term to have a value");let s=null;if(" "===this._source[this._index]){const t=this._index;this.skipInlineWS(),"."===this._source[this._index]&&(this._index=t,s=this.getAttributes())}if(null===s&&"string"==typeof e)this.entries[t]=e;else{if(null===e&&null===s)throw this.error("Expected message to have a value or attributes");this.entries[t]={},null!==e&&(this.entries[t].val=e),null!==s&&(this.entries[t].attrs=s)}}skipWS(){let t=this._source[this._index];for(;" "===t||"\n"===t||"\t"===t||"\r"===t;)t=this._source[++this._index]}skipInlineWS(){let t=this._source[this._index];for(;" "===t||"\t"===t;)t=this._source[++this._index]}skipBlankLines(){for(;;){const t=this._index;if(this.skipInlineWS(),"\n"!==this._source[this._index]){this._index=t;break}this._index+=1}}getIdentifier(t=h){t.lastIndex=this._index;const e=t.exec(this._source);if(null===e)throw this._index+=1,this.error(`Expected an identifier [${t.toString()}]`);return this._index=t.lastIndex,e[0]}getEntryIdentifier(){return this.getIdentifier(o)}getVariantName(){let t="";const e=this._index;let s=this._source.charCodeAt(this._index);if(!(s>=97&&s<=122||s>=65&&s<=90||95===s||32===s))throw this.error("Expected a keyword (starting with [a-zA-Z_])");for(s=this._source.charCodeAt(++this._index);s>=97&&s<=122||s>=65&&s<=90||s>=48&&s<=57||95===s||45===s||32===s;)s=this._source.charCodeAt(++this._index);for(;32===this._source.charCodeAt(this._index-1);)this._index--;return{type:"varname",name:t+=this._source.slice(e,this._index)}}getString(){let t="";for(this._index++;this._index<this._length;){const e=this._source[this._index];if('"'===e){this._index++;break}if("\n"===e)throw this.error("Unterminated string expression");"\\"===e?t+=this.getEscapedCharacter(["{","\\",'"']):(this._index++,t+=e)}return t}getPattern(){const t=this._index;let e=this._source.indexOf("\n",this._index);-1===e&&(e=this._length);const s=t!==e?this._source.slice(t,e).replace(u,""):null;if(s&&(s.includes("{")||s.includes("\\")))return this.getComplexPattern();if(this._index=e+1,this.skipBlankLines()," "!==this._source[this._index])return s;const i=this._index;return this.skipInlineWS(),"."===this._source[this._index]?(this._index=i,s):(s&&(this._index=t),this.getComplexPattern())}getComplexPattern(){let t="";const e=[];let s=0,i=this._source[this._index];for(;this._index<this._length;)if("\n"!==i){if(void 0===i)break;if("\\"!==i)if("{"!==i)t+=i,i=this._source[++this._index];else{if(t.length&&e.push(t),s>r-1)throw this.error(`Too many placeables, maximum allowed is ${r}`);t="",e.push(this.getPlaceable()),i=this._source[++this._index],s++}else t+=this.getEscapedCharacter(),i=this._source[this._index]}else{this._index++;const s=this._index;this.skipBlankLines();const n=this._index;if(" "!==this._source[this._index])break;if(this.skipInlineWS(),"}"===this._source[this._index]||"["===this._source[this._index]||"*"===this._source[this._index]||"."===this._source[this._index]){this._index=n;break}((t+=this._source.substring(s,n)).length||e.length)&&(t+="\n"),i=this._source[this._index]}return 0===e.length?t.length?t:null:(t.length&&e.push(t.replace(u,"")),e)}getEscapedCharacter(t=["{","\\"]){this._index++;const e=this._source[this._index];if(t.includes(e))return this._index++,e;if("u"===e){const t=this._source.slice(this._index+1,this._index+5);if(c.test(t))return this._index+=5,String.fromCodePoint(parseInt(t,16));throw this.error(`Invalid Unicode escape sequence: \\u${t}`)}throw this.error(`Unknown escape sequence: \\${e}`)}getPlaceable(){const t=++this._index;if(this.skipWS(),"*"===this._source[this._index]||"["===this._source[this._index]&&"]"!==this._source[this._index+1]){const t=this.getVariants();return{type:"sel",exp:null,vars:t[0],def:t[1]}}this._index=t,this.skipInlineWS();const e=this.getSelectorExpression();this.skipWS();const s=this._source[this._index];if("}"===s){if("getattr"===e.type&&e.id.name.startsWith("-"))throw this.error("Attributes of private messages cannot be interpolated.");return e}if("-"!==s||">"!==this._source[this._index+1])throw this.error('Expected "}" or "->"');if("ref"===e.type)throw this.error("Message references cannot be used as selectors.");if("getvar"===e.type)throw this.error("Variants cannot be used as selectors.");if("getattr"===e.type&&!e.id.name.startsWith("-"))throw this.error("Attributes of public messages cannot be used as selectors.");if(this._index+=2,this.skipInlineWS(),"\n"!==this._source[this._index])throw this.error("Variants should be listed in a new line");this.skipWS();const i=this.getVariants();if(0===i[0].length)throw this.error("Expected members for the select expression");return{type:"sel",exp:e,vars:i[0],def:i[1]}}getSelectorExpression(){if("{"===this._source[this._index])return this.getPlaceable();const t=this.getLiteral();if("ref"!==t.type)return t;if("."===this._source[this._index]){this._index++;const e=this.getIdentifier();return this._index++,{type:"getattr",id:t,name:e}}if("["===this._source[this._index]){this._index++;const e=this.getVariantKey();return this._index++,{type:"getvar",id:t,key:e}}if("("===this._source[this._index]){this._index++;const e=this.getCallArgs();if(!a.test(t.name))throw this.error("Function names must be all upper-case");return this._index++,t.type="fun",{type:"call",fun:t,args:e}}return t}getCallArgs(){const t=[];for(;this._index<this._length;){if(this.skipWS(),")"===this._source[this._index])return t;const e=this.getSelectorExpression();if("ref"!==e.type)t.push(e);else if(this.skipInlineWS(),":"===this._source[this._index]){this._index++,this.skipWS();const s=this.getSelectorExpression();if("string"!=typeof s&&!Array.isArray(s)&&"num"!==s.type)throw this._index=this._source.lastIndexOf(":",this._index)+1,this.error("Expected string in quotes, number.");t.push({type:"narg",name:e.name,val:s})}else t.push(e);if(this.skipWS(),")"===this._source[this._index])break;if(","!==this._source[this._index])throw this.error('Expected "," or ")"');this._index++}return t}getNumber(){let t="",e=this._source.charCodeAt(this._index);if(45===e&&(t+="-",e=this._source.charCodeAt(++this._index)),e<48||e>57)throw this.error(`Unknown literal "${t}"`);for(;e>=48&&e<=57;)t+=this._source[this._index++],e=this._source.charCodeAt(this._index);if(46===e){if(t+=this._source[this._index++],(e=this._source.charCodeAt(this._index))<48||e>57)throw this.error(`Unknown literal "${t}"`);for(;e>=48&&e<=57;)t+=this._source[this._index++],e=this._source.charCodeAt(this._index)}return{type:"num",val:t}}getAttributes(){const t={};for(;this._index<this._length&&" "===this._source[this._index]&&(this.skipInlineWS(),"."===this._source[this._index]);){this._index++;const e=this.getIdentifier();if(this.skipInlineWS(),"="!==this._source[this._index])throw this.error('Expected "="');this._index++,this.skipInlineWS();const s=this.getPattern();if(null===s)throw this.error("Expected attribute to have a value");t[e]="string"==typeof s?s:{val:s},this.skipBlankLines()}return t}getVariants(){const t=[];let e,s=0;for(;this._index<this._length;){const i=this._source[this._index];if(("["!==i||"["===this._source[this._index+1])&&"*"!==i)break;if("*"===i&&(this._index++,e=s),"["!==this._source[this._index])throw this.error('Expected "["');this._index++;const n=this.getVariantKey();this.skipInlineWS();const r=this.getPattern();if(null===r)throw this.error("Expected variant to have a value");t[s++]={key:n,val:r},this.skipWS()}return[t,e]}getVariantKey(){const t=this._source.charCodeAt(this._index);let e;if(e=t>=48&&t<=57||45===t?this.getNumber():this.getVariantName(),"]"!==this._source[this._index])throw this.error('Expected "]"');return this._index++,e}getLiteral(){const t=this._source.charCodeAt(this._index);if(36===t)return this._index++,{type:"var",name:this.getIdentifier()};const e=45===t?this._source.charCodeAt(this._index+1):t;if(e>=97&&e<=122||e>=65&&e<=90)return{type:"ref",name:this.getEntryIdentifier()};if(e>=48&&e<=57)return this.getNumber();if(34===t)return this.getString();throw this.error("Expected literal")}skipComment(){let t=this._source.indexOf("\n",this._index);for(;-1!==t&&"#"===this._source[t+1]&&[" ","#"].includes(this._source[t+2])&&(this._index=t+3,-1!==(t=this._source.indexOf("\n",this._index))););this._index=-1===t?this._length:t+1}error(t){return new SyntaxError(t)}skipToNextEntryStart(){let t=this._index;for(;;){if(0===t||"\n"===this._source[t-1]){const e=this._source.charCodeAt(t);if(e>=97&&e<=122||e>=65&&e<=90||45===e)return void(this._index=t)}if(-1===(t=this._source.indexOf("\n",t)))return void(this._index=this._length);t++}}}class d{constructor(t,e){this.value=t,this.opts=e}valueOf(){return this.value}toString(){throw new Error("Subclasses of FluentType must implement toString.")}}class f extends d{toString(){return this.value||"???"}}class _ extends d{constructor(t,e){super(parseFloat(t),e)}toString(t){try{return t._memoizeIntlObject(Intl.NumberFormat,this.opts).format(this.value)}catch(t){return this.value}}match(t,e){return e instanceof _&&this.value===e.value}}class x extends d{constructor(t,e){super(new Date(t),e)}toString(t){try{return t._memoizeIntlObject(Intl.DateTimeFormat,this.opts).format(this.value)}catch(t){return this.value}}}class p extends d{toString(){return this.value}match(t,e){if(e instanceof p)return this.value===e.value;if("string"==typeof e)return this.value===e;if(e instanceof _){const s=t._memoizeIntlObject(Intl.PluralRules,e.opts);return this.value===s.select(e.value)}return!1}}var g={NUMBER:([t],e)=>new _(t.valueOf(),m(t.opts,e)),DATETIME:([t],e)=>new x(t.valueOf(),m(t.opts,e))};function m(t,e){return Object.assign({},t,function(t){const e={};for(const[s,i]of Object.entries(t))e[s]=i.valueOf();return e}(e))}const w=2500,y="⁨",v="⁩";function b(t,e,s){if(e[s])return e[s];const{errors:i}=t;return i.push(new RangeError("No default")),new f}function k(t,{name:e}){const{bundle:s,errors:i}=t,n=e.startsWith("-")?s._terms.get(e):s._messages.get(e);if(!n){const t=e.startsWith("-")?new ReferenceError(`Unknown term: ${e}`):new ReferenceError(`Unknown message: ${e}`);return i.push(t),new f(e)}return n}function E(t,e){if("string"==typeof e)return t.bundle._transform(e);if(e instanceof f)return e;if(Array.isArray(e))return function(t,e){const{bundle:s,dirty:i,errors:n}=t;if(i.has(e))return n.push(new RangeError("Cyclic reference")),new f;i.add(e);const r=[],o=s._useIsolating&&e.length>1;for(const i of e){if("string"==typeof i){r.push(s._transform(i));continue}const e=E(t,i).toString(s);o&&r.push(y),e.length>w?(n.push(new RangeError("Too many characters in placeable "+`(${e.length}, max allowed is ${w})`)),r.push(e.slice(w))):r.push(e),o&&r.push(v)}return i.delete(e),r.join("")}(t,e);switch(e.type){case"varname":return new p(e.name);case"num":return new _(e.val);case"var":return function(t,{name:e}){const{args:s,errors:i}=t;if(!s||!s.hasOwnProperty(e))return i.push(new ReferenceError(`Unknown variable: ${e}`)),new f(e);const n=s[e];if(n instanceof d)return n;switch(typeof n){case"string":return n;case"number":return new _(n);case"object":if(n instanceof Date)return new x(n);default:return i.push(new TypeError(`Unsupported variable type: ${e}, ${typeof n}`)),new f(e)}}(t,e);case"fun":return S(t,e);case"call":return function(t,{fun:e,args:s}){const i=S(t,e);if(i instanceof f)return i;const n=[],r={};for(const e of s)"narg"===e.type?r[e.name]=E(t,e.val):n.push(E(t,e));try{return i(n,r)}catch(t){return new f}}(t,e);case"ref":return E(t,k(t,e));case"getattr":{const s=function(t,{id:e,name:s}){const i=k(t,e);if(i instanceof f)return i;if(i.attrs)for(const t in i.attrs)if(s===t)return i.attrs[s];const{errors:n}=t;return n.push(new ReferenceError(`Unknown attribute: ${s}`)),E(t,i)}(t,e);return E(t,s)}case"getvar":{const s=function(t,{id:e,key:s}){const i=k(t,e);if(i instanceof f)return i;const{bundle:n,errors:r}=t,o=E(t,s);if(h=i.val,Array.isArray(h)&&"sel"===h[0].type&&null===h[0].exp)for(const e of i.val[0].vars){const s=E(t,e.key);if(o.match(n,s))return e}var h;return r.push(new ReferenceError(`Unknown variant: ${o.toString(n)}`)),E(t,i)}(t,e);return E(t,s)}case"sel":{const s=function(t,{exp:e,vars:s,def:i}){if(null===e)return b(t,s,i);const n=E(t,e);if(n instanceof f)return b(t,s,i);for(const e of s){const s=E(t,e.key);if(!(s instanceof _||s instanceof p))continue;const{bundle:i}=t;if(s.match(i,n))return e}return b(t,s,i)}(t,e);return E(t,s)}case void 0:{if(null!==e.val&&void 0!==e.val)return E(t,e.val);const{errors:s}=t;return s.push(new RangeError("No value")),new f}default:return new f}}function S(t,{name:e}){const{bundle:{_functions:s},errors:i}=t,n=s[e]||g[e];return n?"function"!=typeof n?(i.push(new TypeError(`Function ${e}() is not callable`)),new f(`${e}()`)):n:(i.push(new ReferenceError(`Unknown function: ${e}()`)),new f(`${e}()`))}class I extends Map{constructor(t,e=[]){super(t),this.errors=e}static fromString(t){const[e,s]=(i=t,(new l).getResource(i));var i;return new I(Object.entries(e),s)}}class A{constructor(t,{functions:e={},useIsolating:s=!0,transform:i=(t=>t)}={}){this.locales=Array.isArray(t)?t:[t],this._terms=new Map,this._messages=new Map,this._functions=e,this._useIsolating=s,this._transform=i,this._intls=new WeakMap}get messages(){return this._messages[Symbol.iterator]()}hasMessage(t){return this._messages.has(t)}getMessage(t){return this._messages.get(t)}addMessages(t){const e=I.fromString(t);return this.addResource(e)}addResource(t){const e=t.errors.slice();for(const[s,i]of t)if(s.startsWith("-")){if(this._terms.has(s)){e.push(`Attempt to override an existing term: "${s}"`);continue}this._terms.set(s,i)}else{if(this._messages.has(s)){e.push(`Attempt to override an existing message: "${s}"`);continue}this._messages.set(s,i)}return e}format(t,e,s){return"string"==typeof t?this._transform(t):"string"==typeof t.val?this._transform(t.val):void 0===t.val?null:function(t,e,s,i=[]){return E({bundle:t,args:e,errors:i,dirty:new WeakSet},s).toString(t)}(this,e,t,s)}_memoizeIntlObject(t,e){const s=this._intls.get(t)||{},i=JSON.stringify(e);return s[i]||(s[i]=new t(this.locales,e),this._intls.set(t,s)),s[i]}}function W(t,e){let s="";return s=s+t+" =",e&&e.indexOf("\n")>-1?(s+="\n  ",s+=e.split("\n").join("\n  ")):s=s+" "+e,s}var O=function(t,e){let s="";return Object.keys(t).forEach(e=>{const i=t[e];"string"==typeof i?(s+=W(e,i),s+="\n\n"):(i.comment&&(s+=function(t){let e="";return e=e+"# "+t.split("\n").join("\n# "),e+="\n"}(i.comment)),s+=W(e,i.val),Object.keys(i).forEach(t=>{if("comment"===t||"val"===t)return;const e=i[t];s+=W("\n  ."+t,e)}),s+="\n\n")}),e&&e(null,s),s};function $(t){return!/^\s*$/.test(t)}function C(t){const[e]=t.match(/^\s*/);return e.length}class j{constructor(t,e){this.i18next=t,this.options=e,this.bundles={}}createBundle(e,s,i){const n=i?O(i):"",r=new A(e,this.options.fluentBundleOptions);r.addMessages(function(t){const e=t.split("\n").filter($),s=e.map(C),i=Math.min(...s),n=new RegExp(`^\\s{${i}}`);return e.map(t=>t.replace(n,"")).join("\n")}(n));!function(e,s,i){const{obj:n,k:r}=t(e,s,Object);n[r]=i}(this.bundles,[e,s],r)}createBundleFromI18next(t,s){this.createBundle(t,s,e(this.i18next.store.data,[t,s]))}getBundle(t,s){return e(this.bundles,[t,s])}bind(){this.i18next.store.on("added",(t,e)=>{this.i18next.isInitialized&&this.createBundleFromI18next(t,e)}),this.i18next.on("initialized",()=>{var t=this.i18next.languages||[],e=this.i18next.options.preload||[];t.filter(t=>!e.includes(t)).concat(e).forEach(t=>{this.i18next.options.ns.forEach(e=>{this.createBundleFromI18next(t,e)})})})}}class R{constructor(t){this.type="i18nFormat",this.handleAsObject=!1,this.init(null,t)}init(t,e){const s=t&&t.options&&t.options.i18nFormat||{};this.options=function(t){return i.call(n.call(arguments,1),function(e){if(e)for(var s in e)void 0===t[s]&&(t[s]=e[s])}),t}(s,e,this.options||{},{bindI18nextStore:!0,fluentBundleOptions:{useIsolating:!1}}),t?(this.store=new j(t,this.options),this.options.bindI18nextStore&&this.store.bind(),t.fluent=this):this.store=new j(null,this.options)}parse(t,e,s,i,n,r){const o=this.store.getBundle(s,i),h=n.indexOf(".")>-1;if(!t)return n;const a=h?t.attrs[n.split(".")[1]]:t;return o?o.format(a,e):n}getResource(t,e,s,i){let n=this.store.getBundle(t,e);const r=s.indexOf(".")>-1?s.split(".")[0]:s;if(n)return n.getMessage(r)}addLookupKeys(t,e,s,i,n){return t}}return R.type="i18nFormat",R});
